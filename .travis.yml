sudo: false
os: linux
language: c
cache: ccache
services:
  - docker

notifications:
  email:
    recipients:
      - jasuarez+mesa-travis@igalia.com
      - tanty+mesa-travis@igalia.com

branches:
  only:
    # TODO: tag the released ones using something like
    #       $ git describe | cut -d "-" -f 2
    - released/17.2
    - released/17.3
    - pre-release/17.2
    - pre-release/17.3
    - jasuarez/master
    - jasuarez/17.2
    - jasuarez/17.3
    - agomez/master
    - agomez/17.2
    - agomez/17.3
    - agomez/self-nominated/17.2

env:
  global:
    - LLVM=3.9
    - MAKEFLAGS="-j4"
    - DEBUG=false
    - DO_MESON_BUILD=${MESON_BUILD:-no}
    - DO_TAR_BUILD=${TAR_BUILD:-yes}
    - TAR=false

before_script:
  - wget "$ROCKERFILES_BASE_URL"/"$ROCKERFILE_MESA"
  - wget https://github.com/grammarly/rocker/releases/download/1.3.1/rocker-1.3.1-linux_amd64.tar.gz
  - tar xvf rocker-1.3.1-linux_amd64.tar.gz
  - rm rocker-1.3.1-linux_amd64.tar.gz
  - mkdir -p -m777 ~/.ccache

script:
  - |
    [[ $TAR == true && $DO_TAR_BUILD != yes ]] && ROCKER_BUILD=no
    [[ $BUILD == meson && $DO_MESON_BUILD != yes ]] && ROCKER_BUILD=no
    if [[ $ROCKER_BUILD != no ]]; then
      POSTFIX=$(${DEBUG:-false} && printf ".debug")$([[ $BUILD == distcheck ]] && printf ".distcheck")
      ./rocker build -f $ROCKERFILE_MESA --var BUILD=$BUILD --var LLVM=$LLVM --var DEBUG=$DEBUG --var TAR=$TAR --var TAG=${TRAVIS_BRANCH%%/*}-${TRAVIS_BRANCH##*/}$POSTFIX
    fi

after_success:
  - |
    [[ ${TRAVIS_BRANCH%%/*} == pre-release || ${TRAVIS_BRANCH%%/*} == released ]] && DOCKER_PUSH=yes
    [[ ${TRAVIS_BRANCH} == jasuarez/master ]] && DOCKER_PUSH=yes
    [[ ${TRAVIS_BRANCH} =~ ^agomez* ]] && DOCKER_PUSH=yes
    if [[ -n $DOCKER_USERNAME && $TRAVIS_PULL_REQUEST == false && $DOCKER_PUSH == yes ]]; then
      POSTFIX=$(${DEBUG:-false} && printf ".debug")$([[ $BUILD == distcheck ]] && printf ".distcheck")
      docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"
      docker push "$DOCKER_REPOSITORY"/"$DOCKER_IMAGE_NAME":${TRAVIS_BRANCH%%/*}-${TRAVIS_BRANCH##*/}$POSTFIX
    fi

jobs:
  include:
    - stage: Basic builds
      env: BUILD=meson
      after_success: skip
    - env: BUILD=autotools
    - env: BUILD=autotools DEBUG=true
    - env: BUILD=distcheck
    - env: BUILD=gallium LLVM=5.0
      after_success: skip
    - env: BUILD=gallium LLVM=4.0
      after_success: skip
    - env: BUILD=gallium LLVM=3.9
      after_success: skip
    - env: BUILD=gallium LLVM=3.8
      after_success: skip
    - env: BUILD=gallium LLVM=3.6
      after_success: skip
    - env: BUILD=gallium LLVM=3.3
      after_success: skip
    - env: BUILD=gallium LLVM=0.0
      after_success: skip
    - env: BUILD=scons
      after_success: skip
    - env: BUILD=scons LLVM=0.0
      after_success: skip
    - env: BUILD=windows
      after_success: skip

    - stage: Post distcheck builds
      env: BUILD=meson TAR=true
      after_success: skip
    - env: BUILD=autotools TAR=true
      after_success: skip
    - env: BUILD=scons TAR=true
      after_success: skip
    - env: BUILD=windows TAR=true
      after_success: skip
