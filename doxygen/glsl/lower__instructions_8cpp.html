<html>
<head>
<title>Mesa Source Code Documentation</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head>
<body>
<div class="qindex">
<a class="qindex" href="../main/index.html">core</a> |
<a class="qindex" href="../glapi/index.html">glapi</a> |
<a class="qindex" href="../glsl/index.html">glsl</a> |
<a class="qindex" href="../nir/index.html">nir</a> |
<a class="qindex" href="../vbo/index.html">vbo</a> |
<a class="qindex" href="../math/index.html">math</a> |
<a class="qindex" href="../swrast/index.html">swrast</a> |
<a class="qindex" href="../swrast_setup/index.html">swrast_setup</a> |
<a class="qindex" href="../tnl/index.html">tnl</a> |
<a class="qindex" href="../tnl_dd/index.html">tnl_dd</a> |
<a class="qindex" href="../gbm/index.html">gbm</a> |
<a class="qindex" href="../i965/index.html">i965</a>
</div>
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_f13bc85843fa14191e0ad4a3a157cf60.html">compiler</a></li><li class="navelem"><a class="el" href="dir_4172b1ff1383a72421e897c24b01e6f0.html">glsl</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">lower_instructions.cpp File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Many GPUs lack native instructions for certain expression operations, and must replace them with some other expression tree.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &quot;c99_math.h&quot;</code><br />
<code>#include &quot;program/prog_instruction.h&quot;</code><br />
<code>#include &quot;compiler/glsl_types.h&quot;</code><br />
<code>#include &quot;<a class="el" href="ir_8h.html">ir.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="ir__builder_8h.html">ir_builder.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="ir__optimization_8h.html">ir_optimization.h</a>&quot;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a077773d9cfaed46d14070f8d0c4eb1a8"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="lower__instructions_8cpp.html#a077773d9cfaed46d14070f8d0c4eb1a8">lowering</a>(x)&#160;&#160;&#160;(this-&gt;lower &amp; x)</td></tr>
<tr class="memdesc:a077773d9cfaed46d14070f8d0c4eb1a8"><td class="mdescLeft">&#160;</td><td class="mdescRight">Determine if a particular type of lowering should occur.  <a href="#a077773d9cfaed46d14070f8d0c4eb1a8">More...</a><br /></td></tr>
<tr class="separator:a077773d9cfaed46d14070f8d0c4eb1a8"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a609742f45a0fc3f1f96f435972707aca"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="lower__instructions_8cpp.html#a609742f45a0fc3f1f96f435972707aca">lower_instructions</a> (<a class="el" href="structexec__list.html">exec_list</a> *instructions, unsigned what_to_lower)</td></tr>
<tr class="separator:a609742f45a0fc3f1f96f435972707aca"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Many GPUs lack native instructions for certain expression operations, and must replace them with some other expression tree. </p>
<p>This pass lowers some of the most common cases, allowing the lowering code to be implemented once rather than in each driver backend.</p>
<p>Currently supported transformations:</p><ul>
<li>SUB_TO_ADD_NEG</li>
<li>DIV_TO_MUL_RCP</li>
<li>INT_DIV_TO_MUL_RCP</li>
<li>EXP_TO_EXP2</li>
<li>POW_TO_EXP2</li>
<li>LOG_TO_LOG2</li>
<li>MOD_TO_FLOOR</li>
<li>LDEXP_TO_ARITH</li>
<li>DFREXP_TO_ARITH</li>
<li>CARRY_TO_ARITH</li>
<li>BORROW_TO_ARITH</li>
<li>SAT_TO_CLAMP</li>
<li>DOPS_TO_DFRAC</li>
</ul>
<h2>SUB_TO_ADD_NEG: </h2>
<p>Breaks an ir_binop_sub expression down to add(op0, neg(op1))</p>
<p>This simplifies expression reassociation, and for many backends there is no subtract operation separate from adding the negation. For backends with native subtract operations, they will probably want to recognize add(op0, neg(op1)) or the other way around to produce a subtract anyway.</p>
<h2>FDIV_TO_MUL_RCP, DDIV_TO_MUL_RCP, and INT_DIV_TO_MUL_RCP: </h2>
<p>Breaks an ir_binop_div expression down to op0 * (rcp(op1)).</p>
<p>Many GPUs don't have a divide instruction (945 and 965 included), but they do have an RCP instruction to compute an approximate reciprocal. By breaking the operation down, constant reciprocals can get constant folded.</p>
<p>FDIV_TO_MUL_RCP only lowers single-precision floating point division; DDIV_TO_MUL_RCP only lowers double-precision floating point division. DIV_TO_MUL_RCP is a convenience macro that sets both flags. INT_DIV_TO_MUL_RCP handles the integer case, converting to and from floating point so that RCP is possible.</p>
<h2>EXP_TO_EXP2 and LOG_TO_LOG2: </h2>
<p>Many GPUs don't have a base e log or exponent instruction, but they do have base 2 versions, so this pass converts exp and log to exp2 and log2 operations.</p>
<h2>POW_TO_EXP2: </h2>
<p>Many older GPUs don't have an x**y instruction. For these GPUs, convert x**y to 2**(y * log2(x)).</p>
<h2>MOD_TO_FLOOR: </h2>
<p>Breaks an ir_binop_mod expression down to (op0 - op1 * floor(op0 / op1))</p>
<p>Many GPUs don't have a MOD instruction (945 and 965 included), and if we have to break it down like this anyway, it gives an opportunity to do things like constant fold the (1.0 / op1) easily.</p>
<p>Note: before we used to implement this as op1 * fract(op / op1) but this implementation had significant precision errors.</p>
<h2>LDEXP_TO_ARITH: </h2>
<p>Converts ir_binop_ldexp to arithmetic and bit operations for float sources.</p>
<h2>DFREXP_DLDEXP_TO_ARITH: </h2>
<p>Converts ir_binop_ldexp, ir_unop_frexp_sig, and ir_unop_frexp_exp to arithmetic and bit ops for double arguments.</p>
<h2>CARRY_TO_ARITH: </h2>
<p>Converts ir_carry into (x + y) &lt; x.</p>
<h2>BORROW_TO_ARITH: </h2>
<p>Converts ir_borrow into (x &lt; y).</p>
<h2>SAT_TO_CLAMP: </h2>
<p>Converts ir_unop_saturate into min(max(x, 0.0), 1.0)</p>
<h2>DOPS_TO_DFRAC: </h2>
<p>Converts double trunc, ceil, floor, round to fract </p>
</div><h2 class="groupheader">Macro Definition Documentation</h2>
<a id="a077773d9cfaed46d14070f8d0c4eb1a8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a077773d9cfaed46d14070f8d0c4eb1a8">&sect;&nbsp;</a></span>lowering</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define lowering</td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname">x</td><td>)</td>
          <td>&#160;&#160;&#160;(this-&gt;lower &amp; x)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Determine if a particular type of lowering should occur. </p>

<p>Referenced by <a class="el" href="lower__instructions_8cpp.html#a609742f45a0fc3f1f96f435972707aca">lower_instructions()</a>.</p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="a609742f45a0fc3f1f96f435972707aca"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a609742f45a0fc3f1f96f435972707aca">&sect;&nbsp;</a></span>lower_instructions()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool lower_instructions </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structexec__list.html">exec_list</a> *&#160;</td>
          <td class="paramname"><em>instructions</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned&#160;</td>
          <td class="paramname"><em>what_to_lower</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>References <a class="el" href="namespaceir__builder.html#a9506fd9d53809f50d75de531d517c7bd">ir_builder::abs()</a>, <a class="el" href="namespaceir__builder.html#a5a0655e1d730a274cfa92d510870d071">ir_builder::add()</a>, <a class="el" href="namespaceir__builder.html#a9d10631b8e8bb5d961d2a7d1601bfb50">ir_builder::assign()</a>, <a class="el" href="namespaceir__builder.html#addf97e168a6c16f8c0582d6af59d8a09">ir_builder::b2i()</a>, <a class="el" href="namespaceir__builder.html#ac61056db1a00398adac3180592b433d0">ir_builder::bit_and()</a>, <a class="el" href="ir__optimization_8h.html#a3e2af9f4012317097b3d9d5fc9d0270e">BIT_COUNT_TO_MATH</a>, <a class="el" href="namespaceir__builder.html#a864451b3f4146d12e0194c84a4a65cf7">ir_builder::bit_not()</a>, <a class="el" href="namespaceir__builder.html#a72116d303f460ad340cf2dc54d416220">ir_builder::bit_or()</a>, <a class="el" href="namespaceir__builder.html#a340fd544d63928a694cad4130ef0495f">ir_builder::bitcast_f2i()</a>, <a class="el" href="namespaceir__builder.html#a13b4cccc1b6c1acc09062ada77098406">ir_builder::bitcast_f2u()</a>, <a class="el" href="namespaceir__builder.html#ade5ab3bb9b752299275c47f7968a6441">ir_builder::bitcast_u2f()</a>, <a class="el" href="namespaceir__builder.html#abdb3abffe54b7e55c8b058f5a3ceb592">ir_builder::bitfield_insert()</a>, <a class="el" href="ir__optimization_8h.html#aae55b8a11b27f0f434017692e052dc38">BORROW_TO_ARITH</a>, <a class="el" href="namespaceir__builder.html#a5b6ca842af125c89a264ac365b9c083a">ir_builder::carry()</a>, <a class="el" href="ir__optimization_8h.html#a471e0b22065df32c93eb2501b0708a46">CARRY_TO_ARITH</a>, <a class="el" href="namespaceir__builder.html#af218a2a1d264bdf87d50059ff6c632c2">ir_builder::csel()</a>, <a class="el" href="ir__optimization_8h.html#a8fca58813cb5320ac596f9fc1a5ed1ce">DDIV_TO_MUL_RCP</a>, <a class="el" href="ir__optimization_8h.html#a674c34fb472aa975b93ac8c3975931f7">DFREXP_DLDEXP_TO_ARITH</a>, <a class="el" href="ir__optimization_8h.html#a4c7291dc0999618aee76aff048e2239e">DOPS_TO_DFRAC</a>, <a class="el" href="namespaceir__builder.html#a60dcd22ad56ac7128a29165eafb0ed70">ir_builder::equal()</a>, <a class="el" href="namespaceir__builder.html#ab390d07e1afdc381dd079bc366ad7e95">ir_builder::exp()</a>, <a class="el" href="ir__optimization_8h.html#a26ecc91ab0f9ecd400f7e6b7bb37c53d">EXP_TO_EXP2</a>, <a class="el" href="namespaceir__builder.html#a048b56be6e086b54f02bd81c55e1320d">ir_builder::expr()</a>, <a class="el" href="ir__optimization_8h.html#ad2e1648270b843c0e736696f2652b9cb">EXTRACT_TO_SHIFTS</a>, <a class="el" href="ir__optimization_8h.html#a6fe572ae508c32a5433c06cdda37efc9">FDIV_TO_MUL_RCP</a>, <a class="el" href="ir__optimization_8h.html#a9ae05144b762bb5a451cef7c16c89387">FIND_LSB_TO_FLOAT_CAST</a>, <a class="el" href="ir__optimization_8h.html#a7e4cdc3784f4c06a04c5afaa2dd3852b">FIND_MSB_TO_FLOAT_CAST</a>, <a class="el" href="namespaceir__builder.html#a7b9df7d229c6d2d01914cecd09c6b2eb">ir_builder::fma()</a>, <a class="el" href="namespaceir__builder.html#a23a703fdee796af43104d3b92de8e0e5">ir_builder::fract()</a>, <a class="el" href="namespaceir__builder.html#a4698e75649f686fa1419e6cb4628f0ec">ir_builder::gequal()</a>, <a class="el" href="namespaceir__builder.html#a3616b5b3ee69d5006cba6680c999413e">ir_builder::greater()</a>, <a class="el" href="namespaceir__builder.html#af0573ad2261fe5641a630824513485f7">ir_builder::i2u()</a>, <a class="el" href="ir__optimization_8h.html#a3c821b75d264521ee315b3fbf0f303dc">IMUL_HIGH_TO_MUL</a>, <a class="el" href="ir__optimization_8h.html#ac7b1297712f00ff0450528c12346ea8d">INSERT_TO_SHIFTS</a>, <a class="el" href="ir__optimization_8h.html#ad67f6d9668f889b862a678d0827814ef">INT_DIV_TO_MUL_RCP</a>, <a class="el" href="builtin__functions_8cpp.html#a946410611eec03b248298859d214fcec">ir_unop_log</a>, <a class="el" href="builtin__functions_8cpp.html#ad88fa0b254beb0882e565521f274f2fd">ir_unop_log2</a>, <a class="el" href="ir__optimization_8h.html#a586fa683084b4eff7632f5ab57d49d70">LDEXP_TO_ARITH</a>, <a class="el" href="namespaceir__builder.html#aca2cf24ce2cd26412d12ba1f4813fbf8">ir_builder::less()</a>, <a class="el" href="ir__optimization_8h.html#a9a76cfc6827467fec8039122b86da13f">LOG_TO_LOG2</a>, <a class="el" href="namespaceir__builder.html#a60373bd01a0d8653adb0be09c6571e8c">ir_builder::logic_and()</a>, <a class="el" href="lower__instructions_8cpp.html#a077773d9cfaed46d14070f8d0c4eb1a8">lowering</a>, <a class="el" href="namespaceir__builder.html#a9b844a062ffd2e99aecb89520aa7aa8e">ir_builder::lshift()</a>, <a class="el" href="ir__optimization_8h.html#a3ac1cb87a3908ed39be8b7e0229f0d7a">MOD_TO_FLOOR</a>, <a class="el" href="namespaceir__builder.html#a678ef47af304cafae0797ffdbe6a0d4c">ir_builder::mul()</a>, <a class="el" href="namespaceir__builder.html#a8074b4d28b48d8e0b6a17ceb8037c92d">ir_builder::neg()</a>, <a class="el" href="namespaceir__builder.html#ad5f2bc45c1a948953fb84b3c9269fc3a">ir_builder::nequal()</a>, <a class="el" href="ir__optimization_8h.html#a7e88ebc2e547e05d737e8f1c74b26b6d">POW_TO_EXP2</a>, <a class="el" href="ir__optimization_8h.html#ac744f98cd035ed7117661132d571e090">REVERSE_TO_SHIFTS</a>, <a class="el" href="namespaceir__builder.html#a2d8b89d7b2e3f821bd4639f01c6fe4b6">ir_builder::rshift()</a>, <a class="el" href="ir__optimization_8h.html#ab795de77d69975df87923bf923ab67fd">SAT_TO_CLAMP</a>, <a class="el" href="ir__optimization_8h.html#a53e9e46c0f73875b4d231190c2ed8189">SQRT_TO_ABS_SQRT</a>, <a class="el" href="namespaceir__builder.html#aabe5c3701a9b5b67d780c106c8498b16">ir_builder::sub()</a>, <a class="el" href="ir__optimization_8h.html#a12a5219b7cdba9acde52095dc2d3b831">SUB_TO_ADD_NEG</a>, <a class="el" href="namespaceir__builder.html#a5011187dcafef3363491298f6965e301">ir_builder::swizzle()</a>, <a class="el" href="namespaceir__builder.html#a4eb5b2fca8ecd22be10feeae7ea3a318">ir_builder::swizzle_y()</a>, <a class="el" href="namespaceir__builder.html#a2aafc1f4e68d0a25bfb48ca7566e875a">ir_builder::u2f()</a>, <a class="el" href="namespaceir__builder.html#a8738c1f13c590955130c28039ac596c7">ir_builder::u2i()</a>, <a class="el" href="classir__builder_1_1operand.html#a005e7c35f04f53d0fe6e3a536ef445ad">ir_builder::operand::val</a>, <a class="el" href="ir__hierarchical__visitor_8h.html#abc930fb5ec5ce8ece2a0d53e2f9a3909a54d59cf42b2bf51290d86febf6c3745a">visit_continue</a>, <a class="el" href="ir__hv__accept_8cpp.html#ae09ad67f6b8034581e991d76bbc7d902">visit_list_elements()</a>, <a class="el" href="namespaceir__builder.html#a30137d995fd5f1a610ed2c477b733b87a8e85d373fe37605a8be9f1465ea4da8d">ir_builder::WRITEMASK_X</a>, and <a class="el" href="namespaceir__builder.html#a30137d995fd5f1a610ed2c477b733b87ada079f93d1c73a23778f16e8a050c172">ir_builder::WRITEMASK_Y</a>.</p>

<p>Referenced by <a class="el" href="ir__optimization_8h.html#aab0cfdc8611fe7e19824c3382e8eb780">do_common_optimization()</a>, and <a class="el" href="test__optpass_8cpp.html#a8a19eefda8984dbd5d14e58acb3c3189">do_optimization()</a>.</p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.12
</small></address>
</body>
</html>
