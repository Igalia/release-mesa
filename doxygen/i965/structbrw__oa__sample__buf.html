<html>
<head>
<title>Mesa Source Code Documentation</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head>
<body>
<div class="qindex">
<a class="qindex" href="../main/index.html">core</a> |
<a class="qindex" href="../glapi/index.html">glapi</a> |
<a class="qindex" href="../glsl/index.html">glsl</a> |
<a class="qindex" href="../nir/index.html">nir</a> |
<a class="qindex" href="../vbo/index.html">vbo</a> |
<a class="qindex" href="../math/index.html">math</a> |
<a class="qindex" href="../swrast/index.html">swrast</a> |
<a class="qindex" href="../swrast_setup/index.html">swrast_setup</a> |
<a class="qindex" href="../tnl/index.html">tnl</a> |
<a class="qindex" href="../tnl_dd/index.html">tnl_dd</a> |
<a class="qindex" href="../gbm/index.html">gbm</a> |
<a class="qindex" href="../i965/index.html">i965</a>
</div>
<!-- Generated by Doxygen 1.8.12 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#pub-attribs">Data Fields</a>  </div>
  <div class="headertitle">
<div class="title">brw_oa_sample_buf Struct Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Periodic OA samples are read() into these buffer structures via the i915 perf kernel interface and appended to the brw-&gt;perfquery.sample_buffers linked list.  
 <a href="structbrw__oa__sample__buf.html#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-attribs"></a>
Data Fields</h2></td></tr>
<tr class="memitem:a3a1058962852000184fd0453f2e62ab8"><td class="memItemLeft" align="right" valign="top">struct <a class="elRef" doxygen="/opt/mesa/i965/mesa/doxygen/glsl.tag:../glsl/" href="../glsl/structexec__node.html">exec_node</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structbrw__oa__sample__buf.html#a3a1058962852000184fd0453f2e62ab8">link</a></td></tr>
<tr class="separator:a3a1058962852000184fd0453f2e62ab8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adfe13d14bea5df012cfed814d00c4549"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structbrw__oa__sample__buf.html#adfe13d14bea5df012cfed814d00c4549">refcount</a></td></tr>
<tr class="separator:adfe13d14bea5df012cfed814d00c4549"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a79da4d0b8477323a23b4e0b07c1e1e99"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structbrw__oa__sample__buf.html#a79da4d0b8477323a23b4e0b07c1e1e99">len</a></td></tr>
<tr class="separator:a79da4d0b8477323a23b4e0b07c1e1e99"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6a3148a769b28da1474589b58a04a083"><td class="memItemLeft" align="right" valign="top">uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="structbrw__oa__sample__buf.html#a6a3148a769b28da1474589b58a04a083">buf</a> [<a class="el" href="brw__performance__query_8c.html#a09e89ba4147fef132b2f5c245f472f8c">I915_PERF_OA_SAMPLE_SIZE</a> *10]</td></tr>
<tr class="separator:a6a3148a769b28da1474589b58a04a083"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Periodic OA samples are read() into these buffer structures via the i915 perf kernel interface and appended to the brw-&gt;perfquery.sample_buffers linked list. </p>
<p>When we process the results of an OA metrics query we need to consider all the periodic samples between the Begin and End MI_REPORT_PERF_COUNT command markers.</p>
<p>'Periodic' is a simplification as there are other automatic reports written by the hardware also buffered here.</p>
<p>Considering three queries, A, B and C:</p>
<p>Time -&mdash;&gt; ________________A_________________ | | | ________B_________ _____C___________ | | | | | |</p>
<p>And an illustration of sample buffers read over this time frame: [HEAD ][ ][ ][ ][ ][ ][ ][ ][TAIL ]</p>
<p>These nodes may hold samples for query A: [ ][ ][ A ][ A ][ A ][ A ][ A ][ ][ ]</p>
<p>These nodes may hold samples for query B: [ ][ ][ B ][ B ][ B ][ ][ ][ ][ ]</p>
<p>These nodes may hold samples for query C: [ ][ ][ ][ ][ ][ C ][ C ][ C ][ ]</p>
<p>The illustration assumes we have an even distribution of periodic samples so all nodes have the same size plotted against time:</p>
<p>Note, to simplify code, the list is never empty.</p>
<p>With overlapping queries we can see that periodic OA reports may relate to multiple queries and care needs to be take to keep track of sample buffers until there are no queries that might depend on their contents.</p>
<p>We use a node ref counting system where a reference ensures that a node and all following nodes can't be freed/recycled until the reference drops to zero.</p>
<p>E.g. with a ref of one here: [ 0 ][ 0 ][ 1 ][ 0 ][ 0 ][ 0 ][ 0 ][ 0 ][ 0 ]</p>
<p>These nodes could be freed or recycled ("reaped"): [ 0 ][ 0 ]</p>
<p>These must be preserved until the leading ref drops to zero: [ 1 ][ 0 ][ 0 ][ 0 ][ 0 ][ 0 ][ 0 ]</p>
<p>When a query starts we take a reference on the current tail of the list, knowing that no already-buffered samples can possibly relate to the newly-started query. A pointer to this node is also saved in the query object's -&gt;oa.samples_head.</p>
<p>E.g. starting query A while there are two nodes in .sample_buffers: ________________A________ |</p>
<p>[ 0 ][ 1 ] ^_______ Add a reference and store pointer to node in A-&gt;oa.samples_head</p>
<p>Moving forward to when the B query starts with no new buffer nodes: (for reference, i915 perf reads() are only done when queries finish) ________________A_______ | ________B___ | |</p>
<p>[ 0 ][ 2 ] ^_______ Add a reference and store pointer to node in B-&gt;oa.samples_head</p>
<p>Once a query is finished, after an OA query has become 'Ready', once the End OA report has landed and after we we have processed all the intermediate periodic samples then we drop the -&gt;oa.samples_head reference we took at the start.</p>
<p>So when the B query has finished we have: ________________A________ | ______B___________ | | | [ 0 ][ 1 ][ 0 ][ 0 ][ 0 ] ^_______ Drop B-&gt;oa.samples_head reference</p>
<p>We still can't free these due to the A-&gt;oa.samples_head ref: [ 1 ][ 0 ][ 0 ][ 0 ]</p>
<p>When the A query finishes: (note there's a new ref for C's samples_head) ________________A_________________ | | | _____C_________ | | | [ 0 ][ 0 ][ 0 ][ 0 ][ 1 ][ 0 ][ 0 ] ^_______ Drop A-&gt;oa.samples_head reference</p>
<p>And we can now reap these nodes up to the C-&gt;oa.samples_head: [ X ][ X ][ X ][ X ] keeping -&gt; [ 1 ][ 0 ][ 0 ]</p>
<p>We reap old sample buffers each time we finish processing an OA query by iterating the sample_buffers list from the head until we find a referenced node and stop.</p>
<p>Reaped buffers move to a perfquery.free_sample_buffers list and when we come to read() we first look to recycle a buffer from the free_sample_buffers list before allocating a new buffer. </p>
</div><h2 class="groupheader">Field Documentation</h2>
<a id="a6a3148a769b28da1474589b58a04a083"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6a3148a769b28da1474589b58a04a083">&sect;&nbsp;</a></span>buf</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t brw_oa_sample_buf::buf[<a class="el" href="brw__performance__query_8c.html#a09e89ba4147fef132b2f5c245f472f8c">I915_PERF_OA_SAMPLE_SIZE</a> *10]</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Referenced by <a class="el" href="brw__performance__query_8c.html#ad188ec067d7b55680840973aa9557aab">accumulate_oa_reports()</a>, <a class="el" href="brw__performance__query_8c.html#a15512cab16c461bd0edd2335cf6a03b0">brw_begin_perf_query()</a>, <a class="el" href="brw__performance__query_8c.html#af20f13bd6257dadd8df0281334c3a94b">brw_init_perf_query_info()</a>, <a class="el" href="brw__performance__query_8c.html#a0114ebe7a2694b3fe3e82b3a048e6b51">drop_from_unaccumulated_query_list()</a>, <a class="el" href="brw__performance__query_8c.html#a8758a763d760df32e87a153c54a856e5">enumerate_sysfs_metrics()</a>, <a class="el" href="brw__performance__query_8c.html#af66a23d18eb5b369c4edb93c8b129380">free_sample_bufs()</a>, <a class="el" href="brw__performance__query_8c.html#aed6437f6460908bf9867e204a2a0a795">get_free_sample_buf()</a>, <a class="el" href="brw__performance__query_8c.html#a84e96b6dc6d6c0d761b88d6c89920cb8">read_file_uint64()</a>, <a class="el" href="brw__performance__query_8c.html#a23aa7d84ee6c00ed7e60a846b6b575d9">read_oa_samples()</a>, <a class="el" href="brw__performance__query_8c.html#a3c0fed292dc57d90ce036360a4f2d1b1">read_sysfs_drm_device_file_uint64()</a>, and <a class="el" href="brw__performance__query_8c.html#a8b131f3e5d108be2be14ffbcb3275366">reap_old_sample_buffers()</a>.</p>

</div>
</div>
<a id="a79da4d0b8477323a23b4e0b07c1e1e99"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a79da4d0b8477323a23b4e0b07c1e1e99">&sect;&nbsp;</a></span>len</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int brw_oa_sample_buf::len</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Referenced by <a class="el" href="brw__performance__query_8c.html#ad188ec067d7b55680840973aa9557aab">accumulate_oa_reports()</a>, <a class="el" href="brw__performance__query_8c.html#a8758a763d760df32e87a153c54a856e5">enumerate_sysfs_metrics()</a>, <a class="el" href="brw__performance__query_8c.html#aed6437f6460908bf9867e204a2a0a795">get_free_sample_buf()</a>, <a class="el" href="brw__performance__query_8c.html#a271d9814763c79aa059d809c783f9459">get_sysfs_dev_dir()</a>, <a class="el" href="brw__performance__query_8c.html#a23aa7d84ee6c00ed7e60a846b6b575d9">read_oa_samples()</a>, and <a class="el" href="brw__performance__query_8c.html#a3c0fed292dc57d90ce036360a4f2d1b1">read_sysfs_drm_device_file_uint64()</a>.</p>

</div>
</div>
<a id="a3a1058962852000184fd0453f2e62ab8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3a1058962852000184fd0453f2e62ab8">&sect;&nbsp;</a></span>link</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="elRef" doxygen="/opt/mesa/i965/mesa/doxygen/glsl.tag:../glsl/" href="../glsl/structexec__node.html">exec_node</a> brw_oa_sample_buf::link</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Referenced by <a class="el" href="brw__performance__query_8c.html#ad188ec067d7b55680840973aa9557aab">accumulate_oa_reports()</a>, <a class="el" href="brw__performance__query_8c.html#a15512cab16c461bd0edd2335cf6a03b0">brw_begin_perf_query()</a>, <a class="el" href="brw__performance__query_8c.html#af20f13bd6257dadd8df0281334c3a94b">brw_init_perf_query_info()</a>, <a class="el" href="brw__performance__query_8c.html#a0114ebe7a2694b3fe3e82b3a048e6b51">drop_from_unaccumulated_query_list()</a>, <a class="el" href="brw__performance__query_8c.html#af66a23d18eb5b369c4edb93c8b129380">free_sample_bufs()</a>, <a class="el" href="brw__performance__query_8c.html#aed6437f6460908bf9867e204a2a0a795">get_free_sample_buf()</a>, <a class="el" href="brw__performance__query_8c.html#a23aa7d84ee6c00ed7e60a846b6b575d9">read_oa_samples()</a>, and <a class="el" href="brw__performance__query_8c.html#a8b131f3e5d108be2be14ffbcb3275366">reap_old_sample_buffers()</a>.</p>

</div>
</div>
<a id="adfe13d14bea5df012cfed814d00c4549"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adfe13d14bea5df012cfed814d00c4549">&sect;&nbsp;</a></span>refcount</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int brw_oa_sample_buf::refcount</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Referenced by <a class="el" href="brw__performance__query_8c.html#a15512cab16c461bd0edd2335cf6a03b0">brw_begin_perf_query()</a>, <a class="el" href="brw__performance__query_8c.html#a0114ebe7a2694b3fe3e82b3a048e6b51">drop_from_unaccumulated_query_list()</a>, and <a class="el" href="brw__performance__query_8c.html#aed6437f6460908bf9867e204a2a0a795">get_free_sample_buf()</a>.</p>

</div>
</div>
<hr/>The documentation for this struct was generated from the following file:<ul>
<li><a class="el" href="brw__performance__query_8c.html">brw_performance_query.c</a></li>
</ul>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.12
</small></address>
</body>
</html>
